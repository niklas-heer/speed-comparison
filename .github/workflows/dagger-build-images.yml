name: "[Dagger] Build Base Images"

on:
  # Rebuild images when language versions change
  push:
    paths:
      - "dagger-poc/languages.py"
      - "dagger-poc/build_images.py"
    branches:
      - master
  # Manual trigger with optional specific languages
  workflow_dispatch:
    inputs:
      languages:
        description: 'Languages to build (space-separated, e.g., "rust go python"). Leave empty for changed only, "all" for everything.'
        required: false
        type: string
      dry_run:
        description: "Dry run (don't push to registry)"
        required: false
        type: boolean
        default: false
      force_all:
        description: "Force rebuild all images (ignore change detection)"
        required: false
        type: boolean
        default: false
      check_registry:
        description: "Check registry for missing images (disable to only build specified languages)"
        required: false
        type: boolean
        default: true
  # Called by other workflows (e.g., dagger-benchmark.yml)
  workflow_call:
    inputs:
      languages:
        description: "Languages to build (space-separated)"
        required: false
        type: string
      dry_run:
        required: false
        type: boolean
        default: false
      force_all:
        required: false
        type: boolean
        default: false
      check_registry:
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io/${{ github.repository }}
  DAGGER_VERSION: "0.19.8"

jobs:
  # Determine which images to build
  prepare:
    runs-on: ubicloud-standard-2
    permissions:
      contents: read
      packages: read
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_languages: ${{ steps.matrix.outputs.has_languages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need previous commit to detect changes

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Log in to GHCR (for registry checks)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect changed languages
        id: matrix
        working-directory: dagger-poc
        env:
          REGISTRY: ${{ env.REGISTRY }}
        run: |
          uv sync --quiet

          # Manual input takes priority
          if [ -n "${{ inputs.languages }}" ]; then
            if [ "${{ inputs.languages }}" = "all" ]; then
              echo "Building all languages (manual request)"
              LANGS=$(uv run python -c "from languages import LANGUAGES; print(' '.join(LANGUAGES.keys()))")
            else
              echo "Building specified languages: ${{ inputs.languages }}"
              LANGS="${{ inputs.languages }}"
            fi
          elif [ "${{ inputs.force_all }}" = "true" ]; then
            echo "Building all languages (force_all=true)"
            LANGS=$(uv run python -c "from languages import LANGUAGES; print(' '.join(LANGUAGES.keys()))")
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Detect which languages changed by comparing languages.py
            echo "Detecting changed languages..."

            # Check if build_images.py changed (rebuild all)
            if git diff --name-only HEAD~1 HEAD | grep -q "dagger-poc/build_images.py"; then
              echo "build_images.py changed - rebuilding all"
              LANGS=$(uv run python -c "from languages import LANGUAGES; print(' '.join(LANGUAGES.keys()))")
            else
              # Get changed languages by diffing the Language definitions
              # Also check for missing images in the registry
              LANGS=$(uv run python detect_changes.py --check-registry)
            fi
          elif [ "${{ inputs.check_registry }}" = "true" ]; then
            # Check registry for missing images
            echo "Checking registry for missing images..."
            LANGS=$(uv run python detect_changes.py --check-registry)
          else
            # Default: build all
            LANGS=$(uv run python -c "from languages import LANGUAGES; print(' '.join(LANGUAGES.keys()))")
          fi

          # Trim whitespace
          LANGS=$(echo "$LANGS" | xargs)

          if [ -z "$LANGS" ]; then
            echo "No languages to build"
            echo "has_languages=false" >> $GITHUB_OUTPUT
            echo "matrix={\"language\":[]}" >> $GITHUB_OUTPUT
          else
            echo "Languages to build: $LANGS"
            echo "has_languages=true" >> $GITHUB_OUTPUT
            JSON_ARRAY=$(echo "$LANGS" | tr ' ' '\n' | jq -R . | jq -s -c .)
            echo "matrix={\"language\":$JSON_ARRAY}" >> $GITHUB_OUTPUT
          fi

  # Build images in parallel
  build:
    needs: prepare
    if: needs.prepare.outputs.has_languages == 'true'
    runs-on: ubicloud-standard-4
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Dagger
        run: |
          curl -fsSL https://dl.dagger.io/dagger/install.sh | DAGGER_VERSION=${{ env.DAGGER_VERSION }} BIN_DIR=/usr/local/bin sudo -E sh

      - name: Log in to GHCR
        if: ${{ !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        working-directory: dagger-poc
        env:
          REGISTRY: ${{ env.REGISTRY }}
        run: |
          uv sync --quiet

          PUSH_FLAG=""
          if [ "${{ inputs.dry_run }}" != "true" ]; then
            PUSH_FLAG="--push"
          fi

          uv run dagger run python build_images.py ${{ matrix.language }} $PUSH_FLAG

  # Summary of built images
  summary:
    needs: [prepare, build]
    runs-on: ubicloud-standard-2
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Registry: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "Dry run: ${{ inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.prepare.outputs.has_languages }}" != "true" ]; then
            echo "**No languages needed rebuilding.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Languages rebuilt:** ${{ needs.prepare.outputs.matrix }}" >> $GITHUB_STEP_SUMMARY
          fi
