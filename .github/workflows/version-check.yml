name: Version Check

on:
  schedule:
    # Run weekly on Mondays at 6 AM UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      language:
        description: "Specific language to check (leave empty for all)"
        required: false
        type: string
      dry_run:
        description: "Dry run - check versions but do not create PRs"
        required: false
        type: boolean
        default: false

env:
  EARTHLY_VERSION: "0.8.15"

jobs:
  # Discover all language targets from Earthfile
  discover:
    runs-on: ubicloud-standard-2
    outputs:
      languages: ${{ steps.discover.outputs.languages }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover language targets
        id: discover
        run: |
          if [ -n "${{ inputs.language }}" ]; then
            # Single language specified
            echo "languages=[\"${{ inputs.language }}\"]" >> $GITHUB_OUTPUT
          else
            # Discover all languages
            LANGUAGES=$(./scripts/discover-languages.sh)
            echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
          fi

  # Check for version updates
  check-versions:
    needs: discover
    runs-on: ubicloud-standard-2
    strategy:
      matrix:
        language: ${{ fromJson(needs.discover.outputs.languages) }}
      fail-fast: false
      max-parallel: 10
    outputs:
      # These outputs are per-matrix job, we'll aggregate in the next job
      result: ${{ steps.check.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check for new version
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/check-versions.py ${{ matrix.language }} --json > result.json
          cat result.json

          # Extract results
          HAS_UPDATE=$(jq -r '.results[0].has_update' result.json)
          CURRENT=$(jq -r '.results[0].current_version // "unknown"' result.json)
          LATEST=$(jq -r '.results[0].latest_version // "unknown"' result.json)
          ERROR=$(jq -r '.results[0].error // ""' result.json)

          echo "has_update=$HAS_UPDATE" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "new_version=$LATEST" >> $GITHUB_OUTPUT
          echo "error=$ERROR" >> $GITHUB_OUTPUT

          # Save result for aggregation
          echo "{\"language\": \"${{ matrix.language }}\", \"has_update\": $HAS_UPDATE, \"current\": \"$CURRENT\", \"latest\": \"$LATEST\"}" > ${{ matrix.language }}-result.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: version-check-${{ matrix.language }}
          path: ${{ matrix.language }}-result.json
          retention-days: 1

  # Aggregate results and trigger updates
  process-updates:
    needs: check-versions
    runs-on: ubicloud-standard-2
    if: ${{ !inputs.dry_run }}
    outputs:
      languages_to_update: ${{ steps.aggregate.outputs.languages_to_update }}
      has_updates: ${{ steps.aggregate.outputs.has_updates }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: version-check-*
          path: results-raw
          merge-multiple: false

      - name: Aggregate results
        id: aggregate
        run: |
          echo "Aggregating version check results..."

          # Collect all results
          UPDATES=()
          for file in results-raw/version-check-*/*.json; do
            if [ -f "$file" ]; then
              LANG=$(jq -r '.language' "$file")
              HAS_UPDATE=$(jq -r '.has_update' "$file")
              if [ "$HAS_UPDATE" = "true" ]; then
                UPDATES+=("$LANG")
                echo "Update available for: $LANG"
              fi
            fi
          done

          if [ ${#UPDATES[@]} -eq 0 ]; then
            echo "No updates found"
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "languages_to_update=[]" >> $GITHUB_OUTPUT
          else
            echo "Updates found for: ${UPDATES[*]}"
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # Convert to JSON array (compact, single line for GitHub Actions)
            JSON_ARRAY=$(printf '%s\n' "${UPDATES[@]}" | jq -R . | jq -sc .)
            echo "languages_to_update=$JSON_ARRAY" >> $GITHUB_OUTPUT
          fi

  # Update all languages in a single bundled PR
  update-bundle:
    needs: process-updates
    if: needs.process-updates.outputs.has_updates == 'true'
    runs-on: ubicloud-standard-4
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: version-check-*
          path: results-raw
          merge-multiple: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Claude Code and Router
        run: |
          npm install -g @anthropic-ai/claude-code
          npm install -g @musistudio/claude-code-router

      - name: Configure Claude Code Router
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          mkdir -p ~/.claude-code-router
          cat > ~/.claude-code-router/config.json << EOF
          {
            "Providers": [
              {
                "name": "openrouter",
                "api_base_url": "https://openrouter.ai/api/v1/chat/completions",
                "api_key": "$OPENROUTER_API_KEY",
                "models": ["anthropic/claude-opus-4.5"],
                "transformer": { "use": ["openrouter"] }
              }
            ],
            "Router": {
              "default": "openrouter,anthropic/claude-opus-4.5"
            }
          }
          EOF

      - name: Setup Earthly
        uses: earthly/actions-setup@v1
        with:
          version: ${{ env.EARTHLY_VERSION }}

      - name: Install useful tools
        run: |
          # Install tools that Claude may want to use for verification
          sudo apt-get update -qq
          sudo apt-get install -y -qq curl wget jq > /dev/null

      - name: Apply updates (bundled)
        id: bundle
        run: |
          set -euo pipefail

          LANGUAGES=$(echo '${{ needs.process-updates.outputs.languages_to_update }}' | jq -r '.[]')
          if [ -z "$LANGUAGES" ]; then
            echo "No languages to update."
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "updates=[]" >> $GITHUB_OUTPUT
            echo "failures=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          UPDATES=()
          : > /tmp/updates.md
          : > /tmp/failures.jsonl

          for LANG in $LANGUAGES; do
            echo "::group::Update $LANG"

            FILE="results-raw/version-check-${LANG}/${LANG}-result.json"
            if [ ! -f "$FILE" ]; then
              echo "Missing result file: $FILE"
              echo "{\"language\":\"$LANG\",\"error\":\"missing_result\"}" >> /tmp/failures.jsonl
              echo "::endgroup::"
              continue
            fi

            CURRENT=$(jq -r '.current // empty' "$FILE")
            LATEST=$(jq -r '.latest // empty' "$FILE")

            if [ -z "$CURRENT" ] || [ -z "$LATEST" ]; then
              echo "Missing version info for $LANG"
              echo "{\"language\":\"$LANG\",\"current\":\"$CURRENT\",\"latest\":\"$LATEST\",\"error\":\"missing_version\"}" >> /tmp/failures.jsonl
              echo "::endgroup::"
              continue
            fi

            EXT=$(python3 -c "
            import json
            with open('scripts/version-sources.json') as f:
                data = json.load(f)
            src = data.get('${LANG}', {}).get('source_file', '')
            print(src.split('.')[-1] if '.' in src else '')
            ")

            # Prepare update prompt
            PROMPT=$(cat .github/prompts/update-language.md | \
              sed "s/{{LANGUAGE}}/${LANG}/g" | \
              sed "s/{{CURRENT_VERSION}}/${CURRENT}/g" | \
              sed "s/{{NEW_VERSION}}/${LATEST}/g")
            echo "$PROMPT" > /tmp/update-prompt.md

            echo "Running Claude Code via router to update Earthfile..."
            cat /tmp/update-prompt.md | ccr code -p \
              --allowedTools "Read,Edit,Bash" \
              --dangerously-skip-permissions

            echo "Running quick validation build..."
            if earthly --build-arg QUICK_TEST_ROUNDS=10000 +${LANG} 2>&1 | tee build-output.txt; then
              if git diff --quiet; then
                echo "No changes detected for ${LANG}"
                rm -f build-output.txt /tmp/update-prompt.md
                echo "::endgroup::"
                continue
              fi
              git add -A
              git commit -m "chore(${LANG}): update to ${LATEST}"
              UPDATES+=("$LANG")
              echo "- ${LANG}: ${CURRENT} -> ${LATEST}" >> /tmp/updates.md
              rm -f build-output.txt /tmp/update-prompt.md
              echo "::endgroup::"
              continue
            fi

            ERROR_OUTPUT=$(tail -100 build-output.txt)
            FIXED=false

            for attempt in 1 2 3; do
              echo "::group::Fix attempt ${attempt}"

              FIX_PROMPT=$(cat .github/prompts/fix-breaking-changes.md | \
                sed "s/{{LANGUAGE}}/${LANG}/g" | \
                sed "s/{{NEW_VERSION}}/${LATEST}/g" | \
                sed "s/{{EXT}}/${EXT}/g")

              FIX_PROMPT=$(echo "$FIX_PROMPT" | sed "s|{{ERROR_OUTPUT}}|See error below|g")
              echo -e "$FIX_PROMPT\n\nError output:\n\`\`\`\n$ERROR_OUTPUT\n\`\`\`" > /tmp/fix-prompt.md

              echo "Running Claude Code via router (Opus) to fix issues..."
              cat /tmp/fix-prompt.md | ccr code -p \
                --allowedTools "Read,Edit,Bash,WebSearch" \
                --dangerously-skip-permissions

              echo "::endgroup::"

              echo "Validating fix..."
              if earthly --build-arg QUICK_TEST_ROUNDS=10000 +${LANG} 2>&1 | tee build-output.txt; then
                FIXED=true
                break
              fi

              ERROR_OUTPUT=$(tail -100 build-output.txt)
            done

            if [ "$FIXED" = true ]; then
              if git diff --quiet; then
                echo "No changes detected for ${LANG}"
                rm -f build-output.txt /tmp/update-prompt.md /tmp/fix-prompt.md
                echo "::endgroup::"
                continue
              fi
              git add -A
              git commit -m "chore(${LANG}): update to ${LATEST}"
              UPDATES+=("$LANG")
              echo "- ${LANG}: ${CURRENT} -> ${LATEST}" >> /tmp/updates.md
              rm -f build-output.txt /tmp/update-prompt.md /tmp/fix-prompt.md
              echo "::endgroup::"
              continue
            fi

            echo "Failed to update ${LANG}"
            echo "{\"language\":\"${LANG}\",\"current\":\"${CURRENT}\",\"latest\":\"${LATEST}\",\"error\":\"update_failed\"}" >> /tmp/failures.jsonl
            git restore -SW .
            rm -f build-output.txt /tmp/update-prompt.md /tmp/fix-prompt.md
            echo "::endgroup::"
          done

          if [ ${#UPDATES[@]} -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            UPDATES_JSON=$(printf '%s\n' "${UPDATES[@]}" | jq -R . | jq -sc .)
            echo "updates=$UPDATES_JSON" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "updates=[]" >> $GITHUB_OUTPUT
          fi

          if [ -s /tmp/failures.jsonl ]; then
            FAILURES_JSON=$(jq -sc '.' /tmp/failures.jsonl)
          else
            FAILURES_JSON='[]'
          fi
          echo "failures=$FAILURES_JSON" >> $GITHUB_OUTPUT

      - name: Prepare PR body
        if: steps.bundle.outputs.has_updates == 'true'
        run: |
          COUNT=$(jq -r 'length' <<< '${{ steps.bundle.outputs.updates }}')
          cat > /tmp/pr-body.md << EOF
          ## Automated Version Update (Bundled)

          This PR updates **$COUNT** languages:

          $(cat /tmp/updates.md)

          ### Validation
          - Quick benchmark test passed with \`QUICK_TEST_ROUNDS=10000\` for each updated language

          ---

          > This PR was automatically created by the version-check workflow.
          > Use \`/bench <language>\` to run a full benchmark before merging.
          EOF

      - name: Create or update PR
        if: steps.bundle.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update/version-bundle-${{ github.run_id }}
          delete-branch: true
          title: "chore: update language versions (bundled)"
          body-path: /tmp/pr-body.md
          labels: |
            version-update
            automated
          commit-message: "chore: update language versions"

      - name: Create issues on failures
        if: steps.bundle.outputs.failures != '[]'
        uses: actions/github-script@v7
        with:
          script: |
            const failures = ${{ fromJSON(steps.bundle.outputs.failures) }};
            if (!Array.isArray(failures) || failures.length === 0) {
              return;
            }

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'version-update,needs-manual-fix'
            });

            for (const failure of failures) {
              const lang = failure.language;
              const current = failure.current || 'unknown';
              const latest = failure.latest || 'unknown';
              const title = `Unable to auto-update ${lang} to ${latest}`;

              const exists = issues.data.find(i =>
                i.title.includes(lang) && i.title.includes(latest)
              );

              if (exists) {
                console.log(`Issue already exists: #${exists.number}`);
                continue;
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: `## Automated Update Failed

            The version-check workflow attempted to update **${lang}** but failed.

            | Field | Value |
            |-------|-------|
            | Current Version | \`${current}\` |
            | Target Version | \`${latest}\` |
            | Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

            ### Next Steps

            1. Review the workflow logs for failure details
            2. Check for breaking changes in the new version
            3. Manually update the Earthfile and source files
            4. Test with \`earthly --build-arg QUICK_TEST_ROUNDS=10000 +${lang}\`

            ---

            > This issue was automatically created by the version-check workflow.`,
                labels: ['version-update', 'needs-manual-fix']
              });
            }

  # Summary job
  summary:
    needs: [check-versions, process-updates]
    runs-on: ubicloud-standard-2
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: version-check-*
          path: results-raw
          merge-multiple: false
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# Version Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "results-raw" ]; then
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Language | Current | Latest | Update? |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY

            UPDATES=0
            for file in results-raw/version-check-*/*.json; do
              if [ -f "$file" ]; then
                LANG=$(jq -r '.language' "$file")
                CURRENT=$(jq -r '.current // "?"' "$file")
                LATEST=$(jq -r '.latest // "?"' "$file")
                HAS_UPDATE=$(jq -r '.has_update' "$file")

                if [ "$HAS_UPDATE" = "true" ]; then
                  echo "| **$LANG** | $CURRENT | $LATEST | Yes |" >> $GITHUB_STEP_SUMMARY
                  UPDATES=$((UPDATES + 1))
                else
                  echo "| $LANG | $CURRENT | $LATEST | No |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total updates available:** $UPDATES" >> $GITHUB_STEP_SUMMARY
          else
            echo "No results available." >> $GITHUB_STEP_SUMMARY
          fi
