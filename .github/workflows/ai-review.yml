name: AI PR Review

on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    # Only run for trusted contributors (not first-time contributors from forks)
    # CONTRIBUTOR = has had a PR merged before
    # COLLABORATOR = explicitly added as collaborator
    # MEMBER = org member
    # OWNER = repository owner
    if: >
      github.event.pull_request.author_association == 'CONTRIBUTOR' ||
      github.event.pull_request.author_association == 'COLLABORATOR' ||
      github.event.pull_request.author_association == 'MEMBER' ||
      github.event.pull_request.author_association == 'OWNER'
    steps:
      # SECURITY: Use PR base ref, not head ref, to avoid running untrusted code
      # The action only reads the diff via GitHub API, it doesn't execute PR code
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      - name: AI PR Review
        uses: jonit-dev/openrouter-github-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          open_router_key: ${{ secrets.OPEN_ROUTER_KEY }}
          model_id: "anthropic/claude-sonnet-4.5"
          max_tokens: "4096"
          custom_prompt: |
            You are reviewing a PR for a benchmark project that compares 40+ programming languages using the Leibniz formula for calculating Pi.

            **Project Rules (from CLAUDE.md):**
            1. NO concurrency/parallelism - implementations must be single-threaded
            2. SIMD is allowed but should be separate targets (e.g., swift-simd, cpp-avx2)
            3. Use idiomatic code with standard language features
            4. All implementations must use the Leibniz formula

            **Review Focus:**
            - Does the implementation correctly use the Leibniz formula?
            - Is there any parallelism/concurrency that violates the rules?
            - Is the code idiomatic for the language?
            - For Earthfile changes: Does the target follow project conventions?
            - Are there any potential issues (Alpine compatibility, version parsing)?

            Provide a clear, concise review with:
            1. Summary of what the PR does
            2. Any rule violations or concerns
            3. Code quality observations
            4. Recommendation (approve, request changes, or needs discussion)
