name: AI Assistant

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  assist:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.event.comment.body, '/ai ') &&
      github.event.comment.user.login == 'niklas-heer'
    steps:
      - name: Add reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Get context and generate response
        id: ai
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const prompt = context.payload.comment.body.replace(/^\/ai\s+/, '').trim();

            // Get issue/PR details
            const issue = context.payload.issue;
            const isPR = !!issue.pull_request;

            let contextText = `## ${isPR ? 'Pull Request' : 'Issue'} #${issue.number}: ${issue.title}\n\n`;
            contextText += `**Description:**\n${issue.body || 'No description'}\n\n`;

            // If it's a PR, get the diff
            if (isPR) {
              try {
                const { data: files } = await github.rest.pulls.listFiles({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: issue.number
                });

                contextText += `**Changed files:**\n`;
                for (const file of files.slice(0, 20)) {
                  contextText += `- ${file.filename} (+${file.additions}, -${file.deletions})\n`;
                }
                contextText += '\n';

                // Get patch for smaller PRs
                const totalChanges = files.reduce((sum, f) => sum + f.changes, 0);
                if (totalChanges < 2000) {
                  contextText += `**Diff:**\n\`\`\`diff\n`;
                  for (const file of files) {
                    if (file.patch) {
                      contextText += `--- ${file.filename}\n${file.patch}\n\n`;
                    }
                  }
                  contextText += `\`\`\`\n`;
                }
              } catch (e) {
                contextText += `_Could not fetch PR details: ${e.message}_\n`;
              }
            }

            // Get recent comments for context
            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                per_page: 10
              });

              if (comments.length > 1) {
                contextText += `**Recent comments:**\n`;
                for (const comment of comments.slice(-5)) {
                  if (comment.id !== context.payload.comment.id) {
                    const body = comment.body.length > 500
                      ? comment.body.substring(0, 500) + '...'
                      : comment.body;
                    contextText += `@${comment.user.login}: ${body}\n\n`;
                  }
                }
              }
            } catch (e) {
              // Ignore
            }

            const systemPrompt = `You are an AI assistant helping with a GitHub repository for benchmarking programming languages.

            Project context (from CLAUDE.md):
            - Benchmark comparing 40+ programming languages using the Leibniz formula for Pi
            - Rules: NO concurrency/parallelism, SIMD allowed as separate targets, use idiomatic code
            - Uses Earthly build system with Docker
            - Prefer Alpine over Debian for images

            You are responding to a comment on a ${isPR ? 'pull request' : 'issue'}.
            Be helpful, concise, and technical. Use markdown formatting.
            If asked to review code, check for benchmark rule violations.`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json',
                'HTTP-Referer': 'https://github.com/niklas-heer/speed-comparison',
                'X-Title': 'Speed Comparison AI Assistant'
              },
              body: JSON.stringify({
                model: 'anthropic/claude-opus-4.5',
                messages: [
                  { role: 'system', content: systemPrompt },
                  { role: 'user', content: `${contextText}\n\n---\n\n**User request:** ${prompt}` }
                ],
                max_tokens: 4096
              })
            });

            if (!response.ok) {
              const error = await response.text();
              throw new Error(`OpenRouter API error: ${response.status} - ${error}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;

            core.setOutput('response', aiResponse);

      - name: Post response
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.ai.outputs.response }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: response
            });

            // Add checkmark reaction to original comment
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });
